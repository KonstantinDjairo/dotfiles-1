#!/bin/bash

set -euo pipefail

take_screenshot() {
	maim --hidecursor --format=png --quality 10 "$@"
}

ask_command() {
	dmenu -i -p 'Screenshot which area?' <<-EOF
		selected area
		current window
		full screen
		selected area → clipboard
		current window → clipboard
		full screen → clipboard
		selected area → gimp
	EOF
}

notify() {
	echo "$*"
	notify-send "Maim Pick" "$*"
}

if_installed() {
	for x in "$@"; do
		if ! which "$x" >/dev/null 2>&1 && ! pacman -Qq "$x" >/dev/null 2>&1; then
			notify "$x must be installed for this function."
			return 1
		fi
	done
}

xclip_png() {
	xclip -selection clipboard -t image/png
}

main() {
	if_installed dmenu maim xdotool || exit 1

	local -r screenshot_dir=${MAIM_SCREENSHOTS:-$HOME/Pictures/Screenshots}
	local -r file_path=$screenshot_dir/screenshot-$(date --utc '+%F-%H-%M-%S').png

	mkdir -p -- "$screenshot_dir"

	if (($# == 0)) || [[ -z $1 ]]; then
		local -r command=$(ask_command)
	else
		local -r command=$1
	fi

	case $command in
		*area*clipboard)
			take_screenshot -s | xclip_png
			;;
		*area*gimp)
			take_screenshot -s "$file_path" && gimp "$file_path"
			(sleep 60s && rm -- "$file_path") &
			;;
		*window*clipboard)
			take_screenshot -i "$(xdotool getactivewindow)" | xclip_png
			;;
		full*clipboard)
			take_screenshot | xclip_png
			;;
		*area)
			take_screenshot -s "$file_path"
			;;
		*window)
			take_screenshot -i "$(xdotool getactivewindow)" "$file_path"
			;;
		full*)
			take_screenshot "$file_path"
			;;
		*)
			notify "No appropriate action."
			exit 1
			;;
	esac
}

main "$@"
