#!/bin/bash

# Requires installing mecab from the AUR and ONE of the following:
# - https://ankiweb.net/shared/info/1344485230
# - https://ankiweb.net/shared/info/3918629684
# - https://ankiweb.net/shared/info/13462835

# Open GoldenDict, press "Edit" > "Dictionaries" > "Programs" and add this script,
# like this: mecab-goldendict %GDWORD%
# The script should be in your PATH, or you need to specify the full path to the file.

find_mecab() {
	{
		which mecab --skip-functions --skip-alias ||
			find ~/.local/share/Anki2/addons21 -type f \( -name mecab.lin -o -name mecab \) -print -quit
	} | head -1
}

find_mecab_dicrc() {
	find ~/.local/share/Anki2/addons21 -type f -name dicrc -print -quit
}

sanitize_input() {
	sed -E 's, +,,g; s,[a-z]+, ,Ig'
}

my_mecab() {
	local -r support_dir=$(dirname -- "$(find_mecab_dicrc)")
	"$(find_mecab)" \
		--dicdir="$support_dir" \
		--userdic="$support_dir/user_dic.dic" \
		--rcfile="$support_dir/mecabrc" \
		"$@"
}

mecab_split() {
	sanitize_input <<< "$*" | my_mecab \
		--node-format='<a href="bword:%f[6]">%m</a> ' \
		--unk-format='<a href="bword:%m">%m</a> ' \
		--eos-format='<br> '
}

highlight_word() {
	sed -E "s|(<a[^<>]*>)($*)(</a>)|\1<span class=\"gd-mecab-highlight\">\2</span>\3|g"
}

clip_content=$(xclip -o)
lookup_word=$*

if [[ $clip_content != *"$lookup_word"* ]]; then
	xclip -i <<< "$lookup_word"
	clip_content=$lookup_word
fi

echo '<div class="gd-mecab">'
mecab_split "$clip_content" | highlight_word "$lookup_word"
echo '</div>'

cat <<-'EOF'
<style>
.gd-mecab {
	font-size: 2rem;
}
.gd-mecab-highlight {
	background-color: lightblue;
	border-radius: 0.2rem;
}
a {
	display: inline-block;
	color: royalblue;
	text-decoration: none;
	border-bottom: dashed 2px currentColor;
}
</style>
EOF
