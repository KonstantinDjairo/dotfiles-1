#!/bin/bash -e

# Feed script a url or file location.
# If an image, it will view in sxiv,
# if a video or gif, it will view in mpv
# if a music file or pdf, it will download,
# otherwise it opens link in browser.

# If no url given. Opens browser. For using script as $BROWSER.
[ -z "$*" ] && {
	"$BROWSER"
	exit
}

readonly inv_instances=/tmp/inv_instances

[ -f "$inv_instances" ] || rank_invidious_instances >"$inv_instances"
url=$(
	echo "$*" |
		sed -E \
			-e "s,https?://(www\.)?(youtube\.com/watch\?v=|youtu\.be/)(.*),$(head -1 "$inv_instances" | cut -f1)/watch?v=\3,g;" \
			-e 's|https?://(www\.)?reddit\.com/(.*)|https://teddit.net/\2|g;' \
			-e 's|https?://(www\.)?twitter\.com/(.*)|https://nitter.net/\2|g;' \
			-e 's|https?://(www\.)?instagram\.com/(.*)|https://bibliogram.art/\2|g'
)

case "${url:?}" in
*.mkv | *.webm | *.mp4 | \
	*hooktube.com* | *bitchute.com/video* | *instagram.com* | *twitter.com* | \
	*odysee.com* | \
	*videos.lukesmith.xyz* | \
	*tiktok.com/* | *streamable.com/* | \
	*worldstar.com/web/video* | \
	*youtube.com/watch* | *youtube.com/playlist* | *youtu.be*)
	setsid -f trympv "$url" >/dev/null 2>&1 &
	;;
*.png | *.jpg | *.jpe | *.jpeg | *.gif | \
	*.pdf | *.cbz | *.cbr | \
	*matrix/media/*/download/*)
	filename="$HOME/Downloads/$(echo "$url" | sed "s/.*\///;s/%20/ /g")"
	curl -sL -- "$url" >"$filename"
	new_filename="$filename.$(file --mime-type --brief "$filename" | cut -d/ -f2)"
	mv -- "$filename" "$new_filename"
	setsid -f xdg-open "$new_filename" >/dev/null 2>&1 &
	;;
*.mp3 | *.flac | *.opus | *.mp3?source*)
	qndl "$1" 'curl -LO' >/dev/null 2>&1
	;;
*)
	if [ -f "$url" ]; then
		setsid -f "$TERMINAL" -e "$EDITOR -- $url"
	else
		setsid -f "$BROWSER" -- "$url" >/dev/null 2>&1 &
	fi
	;;
esac
